const SparkPost = require('sparkpost');
const logger = require('local-logger');
const config = require('config');

const emailClient = new SparkPost(process.env.SPARKPOST_KEY);

/**
 * Send transmission email
 *
 * @function
 * @param {Object} user - Information about the user
 * @param {Object} options - SparkPost transmission options
 * @param {String} options.campaignId - SparkPost campaign_id
 * @param {String} options.templateId - SparkPost template_id
 * @param {Object} options.substitutionData - SparkPost email template data
 * @returns {Promise}
 */
function send(user, options) {
  if (!config.mailer.sendEmails) return new Promise(resolve => resolve({ user }));

  return new Promise((resolve, reject) => {
    emailClient.transmissions.send({
      campaign_id: options.campaignId,
      metadata: {
        uuid: user.uuid,
      },
      options: {
        skip_suppression: false,
      },
      content: {
        template_id: options.templateId,
      },
      recipients: [
        {
          address: {
            name: user.first_name,
            email: user.email,
          },
          substitution_data: options.substitutionData(user),
        },
      ],
    }, (err, data) => {
      if (err) {
        logger.info({ campaignId: options.campaignId, data },
          'LOCAL-MAILER: Email could not be sent');

        return reject(err);
      }

      logger.info({ campaignId: options.campaignId, data },
        'LOCAL-MAILER: Email successfully sent');

      return resolve({ data, user });
    });
  });
}

/**
 * Retrieve a recipient list
 *
 * @function
 * @param {Object} listId - Sparkpost list identifier
 * @returns {Promise}
 */
function getList(listId) {
  return new Promise((resolve, reject) => {
    emailClient.recipientLists.get(listId, { show_recipients: true }, (err, data) => {
      if (err) {
        logger.info({ listId }, 'LOCAL-MAILER: List could not be retrieved');
        return reject(err);
      }

      const { recipients, ...info } = data.results;

      logger.info({ listId, info }, 'LOCAL-MAILER: List successfully retrieved');
      return resolve(data);
    });
  });
}

/**
 * Update a recipient list
 *
 * @function
 * @param {Object} listId - Sparkpost list identifier
 * @param {Array} recipientList - Array of recipient objects
 * @returns {Promise}
 */
function updateList(listId, recipientList) {
  return new Promise((resolve, reject) => {
    emailClient.recipientLists.update(listId, { recipients: recipientList }, (err, data) => {
      if (err) {
        logger.info({ listId }, 'LOCAL-MAILER: List could not be updated');
        return reject(err);
      }

      const { recipients, ...info } = data.results;

      logger.info({ listId, info }, 'LOCAL-MAILER: List successfully updated');
      return resolve(data);
    });
  });
}

module.exports = {
  // Transmissions
  send,

  // Recipient Lists
  getList,
  updateList,
};
